const expect = require('chai').expect;
const nock = require('nock');

const getBooks = require('./httpClient').get;
const getBookDetails = require('./httpClient').getDetails;

const response = '<?xml version="1.0" encoding="UTF-8"?><GoodreadsResponse><Request>  <authentication>true</authentication>    <key><![CDATA[4dUTWjXYKXTenf0RBJwMcA]]></key>  <method><![CDATA[search_index]]></method></Request><search><query><![CDATA[react]]></query>  <results-start>1</results-start>  <results-end>20</results-end>  <total-results>502</total-results>  <source>Goodreads</source>  <query-time-seconds>0.19</query-time-seconds>  <results>      <work><id type="integer">49558043</id><books_count type="integer">6</books_count><ratings_count type="integer">132</ratings_count><text_reviews_count type="integer">14</text_reviews_count><original_publication_year type="integer" nil="true"/><original_publication_month type="integer" nil="true"/><original_publication_day type="integer" nil="true"/><average_rating>4.10</average_rating><best_book type="Book">  <id type="integer">29324861</id>  <title>Learning React: Functional Web Development with React and Redux</title>  <author>    <id type="integer">6938934</id>    <name>Alex Banks</name>  </author>  <image_url>https://images.gr-assets.com/books/1494421362m/29324861.jpg</image_url>  <small_image_url>https://images.gr-assets.com/books/1494421362s/29324861.jpg</small_image_url></best_book></work><work><id type="integer">54742113</id><books_count type="integer">3</books_count><ratings_count type="integer">121</ratings_count><text_reviews_count type="integer">18</text_reviews_count><original_publication_year type="integer" nil="true"/><original_publication_month type="integer" nil="true"/><original_publication_day type="integer" nil="true"/><average_rating>4.36</average_rating><best_book type="Book">  <id type="integer">37503118</id>  <title>The Road to learn React</title>  <author>    <id type="integer">16218990</id>    <name>Robin Wieruch</name>  </author>  <image_url>https://s.gr-assets.com/assets/nophoto/book/111x148-bcc042a9c91a29c1d680899eff700a03.png</image_url>  <small_image_url>https://s.gr-assets.com/assets/nophoto/book/50x75-a91bf249278a81aabab721ef782c4a74.png</small_image_url></best_book></work></results></search></GoodreadsResponse>';
const bookDetailRes = '<?xml version="1.0" encoding="UTF-8"?><GoodreadsResponse>  <Request>    <authentication>true</authentication>      <key><![CDATA[4dUTWjXYKXTenf0RBJwMcA]]></key>    <method><![CDATA[book_isbn]]></method>  </Request>  <book>  <id>29324861</id>  <title><![CDATA[Learning React: Functional Web Development with React and Redux]]></title>  <isbn><![CDATA[1491954620]]></isbn>  <isbn13><![CDATA[9781491954621]]></isbn13>  <asin><![CDATA[]]></asin>  <kindle_asin><![CDATA[B071HB1526]]></kindle_asin>  <marketplace_id><![CDATA[A21TJRUUN4KGV]]></marketplace_id>  <country_code><![CDATA[IN]]></country_code>  <image_url>https://images.gr-assets.com/books/1494421362m/29324861.jpg</image_url>  <small_image_url>https://images.gr-assets.com/books/1494421362s/29324861.jpg</small_image_url>  <publication_year>2017</publication_year>  <publication_month>5</publication_month>  <publication_day>18</publication_day>  <publisher>O\'Reilly Media</publisher>  <language_code></language_code>  <is_ebook>false</is_ebook>  <description><![CDATA[If you want to learn how to build efficient user interfaces with React, this is your book. Authors Alex Banks and Eve Porcello show you how to create UIs with this small JavaScript library that can deftly display data changes on large-scale, data-driven websites without page reloads. Along the way, you\'ll learn how to work with functional programming and the latest ECMAScript features.<br /><br />Developed by Facebook, and used by companies including Netflix, Walmart, and <i>The New York Times</i> for large parts of their web interfaces, React is quickly growing in use. By learning how to build React components with this hands-on guide, you\'ll fully understand how useful React can be in your organization.<br /><br /><br />Learn key functional programming concepts with JavaScript<br />Peek under the hood to understand how React runs in the browser<br />Create application presentation layers by mounting and composing React components<br />Use component trees to manage data and reduce the time you spend debugging applications<br />Explore React\'s component lifecycle and use it to load data and improve UI performance<br />Use a routing solution for browser history, bookmarks, and other features of single-page applications<br />Learn how to structure React applications with servers in mind]]></description>  <work>  <id type="integer">49558043</id>  <books_count type="integer">6</books_count>  <best_book_id type="integer">29324861</best_book_id>  <reviews_count type="integer">540</reviews_count>  <ratings_sum type="integer">541</ratings_sum>  <ratings_count type="integer">132</ratings_count>  <text_reviews_count type="integer">14</text_reviews_count>  <original_publication_year type="integer" nil="true"/>  <original_publication_month type="integer" nil="true"/>  <original_publication_day type="integer" nil="true"/>  <original_title nil="true"/>  <original_language_id type="integer" nil="true"/>  <media_type nil="true"/>  <rating_dist>5:43|4:63|3:22|2:4|1:0|total:132</rating_dist>  <desc_user_id type="integer">-51</desc_user_id>  <default_chaptering_book_id type="integer" nil="true"/>  <default_description_language_code nil="true"/></work>  <average_rating>4.10</average_rating>  <num_pages><![CDATA[350]]></num_pages>  <format><![CDATA[Paperback]]></format>  <edition_information><![CDATA[]]></edition_information>  <ratings_count><![CDATA[104]]></ratings_count>  <text_reviews_count><![CDATA[13]]></text_reviews_count>  <url><![CDATA[https://www.goodreads.com/book/show/29324861-learning-react]]></url>  <link><![CDATA[https://www.goodreads.com/book/show/29324861-learning-react]]></link>  <authors><author><id>6938934</id><name>Alex Banks</name><role></role><image_url nophoto=\'false\'><![CDATA[https://images.gr-assets.com/authors/1400470590p5/6938934.jpg]]></image_url><small_image_url nophoto=\'false\'><![CDATA[https://images.gr-assets.com/authors/1400470590p2/6938934.jpg]]></small_image_url><link><![CDATA[https://www.goodreads.com/author/show/6938934.Alex_Banks]]></link><average_rating>4.15</average_rating><ratings_count>164</ratings_count><text_reviews_count>32</text_reviews_count></author><author><id>15032860</id><name>Eve Porcello</name><role></role><image_url nophoto=\'true\'><![CDATA[https://s.gr-assets.com/assets/nophoto/user/u_200x266-e183445fd1a1b5cc7075bb1cf7043306.png]]></image_url><small_image_url nophoto=\'true\'><![CDATA[https://s.gr-assets.com/assets/nophoto/user/u_50x66-632230dc9882b4352d753eedf9396530.png]]></small_image_url><link><![CDATA[https://www.goodreads.com/author/show/15032860.Eve_Porcello]]></link><average_rating>4.02</average_rating><ratings_count>147</ratings_count><text_reviews_count>15</text_reviews_count></author></authors>  <popular_shelves>      <shelf name="to-read" count="216"/>      <shelf name="currently-reading" count="147"/>      <shelf name="programming" count="8"/>      <shelf name="tech" count="4"/>      <shelf name="computer-science" count="3"/>      <shelf name="it" count="3"/>      <shelf name="web-development" count="3"/>      <shelf name="work" count="3"/>      <shelf name="javascript" count="2"/>      <shelf name="software-development" count="2"/>      <shelf name="webdev" count="2"/>      <shelf name="technical" count="2"/>      <shelf name="coding" count="2"/>      <shelf name="english" count="1"/>      <shelf name="aulas" count="1"/>      <shelf name="on-hold" count="1"/>      <shelf name="computer-services" count="1"/>      <shelf name="pdf" count="1"/>      <shelf name="kindle" count="1"/>      <shelf name="epub" count="1"/>      <shelf name="computing" count="1"/>      <shelf name="other" count="1"/>      <shelf name="textbooks" count="1"/>      <shelf name="own-other-ebook" count="1"/>      <shelf name="default" count="1"/>      <shelf name="abandoned-liked" count="1"/>      <shelf name="software" count="1"/>      <shelf name="js" count="1"/>      <shelf name="prioritized-tech" count="1"/>      <shelf name="ifop" count="1"/>      <shelf name="sciences-and-math" count="1"/>      <shelf name="future-hobbies" count="1"/>      <shelf name="backlog" count="1"/>      <shelf name="it-and-computer-science" count="1"/>      <shelf name="programming-and-it" count="1"/>      <shelf name="sd-fe" count="1"/>      <shelf name="safari" count="1"/>      <shelf name="web-design-and-development" count="1"/>      <shelf name="Программирование" count="1"/>      <shelf name="frontend" count="1"/>      <shelf name="react" count="1"/>      <shelf name="library-react" count="1"/>      <shelf name="library" count="1"/>      <shelf name="dataviz" count="1"/>      <shelf name="computer" count="1"/>      <shelf name="next-up" count="1"/>      <shelf name="programming-webdevelopment" count="1"/>      <shelf name="reference" count="1"/>      <shelf name="dev" count="1"/>      <shelf name="reading-list" count="1"/>      <shelf name="3-research" count="1"/>      <shelf name="tech-javascript" count="1"/>      <shelf name="inbox" count="1"/>      <shelf name="skills" count="1"/>      <shelf name="web-design" count="1"/>      <shelf name="design-dev" count="1"/>      <shelf name="code" count="1"/>      <shelf name="technology" count="1"/>      <shelf name="tech-to-read" count="1"/>      <shelf name="zeroes-and-ones" count="1"/>      <shelf name="coding-js" count="1"/>      <shelf name="myself2-0" count="1"/>      <shelf name="p_o-reilly_media" count="1"/>      <shelf name="code-retreat" count="1"/>      <shelf name="owned" count="1"/>  </popular_shelves>  <book_links>    <book_link>  <id>8</id>  <name>Libraries</name>  <link>https://www.goodreads.com/book_link/follow/8</link></book_link>  </book_links>  <buy_links>    <buy_link><id>1</id><name>Amazon</name><link>https://www.goodreads.com/book_link/follow/1</link></buy_link><buy_link><id>10</id><name>Audible</name><link>https://www.goodreads.com/book_link/follow/10</link></buy_link><buy_link><id>3</id><name>Barnes &amp; Noble</name><link>https://www.goodreads.com/book_link/follow/3</link></buy_link><buy_link><id>1027</id><name>Kobo</name><link>https://www.goodreads.com/book_link/follow/1027</link></buy_link><buy_link><id>2102</id><name>Apple Books</name><link>https://www.goodreads.com/book_link/follow/2102</link></buy_link><buy_link><id>8036</id><name>Google Play</name><link>https://www.goodreads.com/book_link/follow/8036</link></buy_link><buy_link><id>4</id><name>Abebooks</name><link>https://www.goodreads.com/book_link/follow/4</link></buy_link><buy_link><id>882</id><name>Book Depository</name><link>https://www.goodreads.com/book_link/follow/882</link></buy_link><buy_link><id>9</id><name>Indigo</name><link>https://www.goodreads.com/book_link/follow/9</link></buy_link><buy_link><id>5</id><name>Alibris</name><link>https://www.goodreads.com/book_link/follow/5</link></buy_link><buy_link><id>107</id><name>Better World Books</name><link>https://www.goodreads.com/book_link/follow/107</link></buy_link><buy_link><id>7</id><name>IndieBound</name><link>https://www.goodreads.com/book_link/follow/7</link></buy_link>  </buy_links>  <series_works>      </series_works></book></GoodreadsResponse>';
describe('Get Books', () => {
    beforeEach(() => {
    nock('http://localhost/')
      .get('/api/search?q=react')
      .reply(200, response);

    nock('http://localhost/')
      .get('/api/getDetails?q=29324861')
      .reply(200, bookDetailRes);
  });

  it('Get books by title', () => {
    return getBooks('react')
      .then(response => {
        expect(typeof response).to.equal('object');

        const result = response.GoodreadsResponse.search.results.work;

        expect(result.length).to.equal(2);
        expect(result[0].best_book.title).to.equal('Learning React: Functional Web Development with React and Redux');
        expect(result[0].ratings_count['#text']).to.equal('132');
        expect(result[0].text_reviews_count['#text']).to.equal('14');

        expect(result[1].best_book.title).to.equal('The Road to learn React');
        expect(result[1].ratings_count['#text']).to.equal('121');
        expect(result[1].text_reviews_count['#text']).to.equal('18');
      });
  });

  it('Get book detail by ISBN id', () => {
    return getBookDetails('29324861')
      .then(response => {
        expect(typeof response).to.equal('object');

        const result = response.GoodreadsResponse.book;

        expect(result.title['#cdata']).to.equal('Learning React: Functional Web Development with React and Redux');
        expect(result.image_url).to.equal('https://images.gr-assets.com/books/1494421362m/29324861.jpg');
        expect(result.ratings_count['#cdata']).to.equal('104');
        expect(result.text_reviews_count['#cdata']).to.equal('13');
      });
  });
}); 